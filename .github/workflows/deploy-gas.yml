name: Deploy Backend (GAS)

on:
  push:
    branches: ['main']
    paths:
      - 'backend/**'
      - '.clasp.json'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Google Apps Script
    runs-on: ubuntu-latest
    environment: google-apps-script
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Install CLASP globally
        run: npm install -g @google/clasp@3.2.0

      - name: Configure CLASP credentials
        run: |
          mkdir -p ~/.clasprc
          cat > ~/.clasprc/.clasprc.json << 'EOF'
          ${{ secrets.GAS_SERVICE_ACCOUNT_KEY }}
          EOF
          echo "✓ CLASP credentials configured"

      - name: Verify .clasp.json exists
        run: |
          if [ ! -f .clasp.json ]; then
            echo "::error:: .clasp.json not found!"
            exit 1
          fi
          echo "✓ .clasp.json found"
          cat .clasp.json

      - name: CLASP Login
        run: |
          clasp login --no-localhost
          echo "✓ CLASP login successful"

      - name: CLASP Status
        run: |
          clasp status
          echo "✓ CLASP status check completed"

      - name: Push code to Google Apps Script
        run: |
          echo "Pushing code to GAS..."
          clasp push --force
          echo "✓ Code pushed successfully"

      - name: Build project
        run: |
          clasp build || true
          echo "✓ Build completed"

      - name: Create deployment
        run: |
          echo "Creating new deployment..."
          clasp deploy --description "GitHub Actions - $(date +%Y-%m-%d_%H:%M:%S)"
          echo "✓ Deployment created"

      - name: Show deployment info
        run: |
          echo "=========================================="
          echo "✅ BACKEND DEPLOYMENT SUCCESSFUL"
          echo "=========================================="
          echo "Script ID: ${{ secrets.GAS_SCRIPT_ID }}"
          echo "Web App URL: https://script.google.com/macros/s/${{ secrets.GAS_SCRIPT_ID }}/exec"
          echo "Test URL: https://script.google.com/macros/s/${{ secrets.GAS_SCRIPT_ID }}/exec?action=testIntegrity"
          echo "=========================================="

      - name: Cleanup sensitive data
        if: always()
        run: |
          rm -rf ~/.clasprc
          echo "✓ Cleanup completed"

