name: Deploy Backend (GAS)

on:
  push:
    branches: ['main']
    paths:
      - 'backend/**'
      - '.clasp.json'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Google Apps Script
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install CLASP
        run: npm install -g @google/clasp

      - name: Setup CLASP credentials
        run: |
          mkdir -p ~/.clasprc
          echo '${{ secrets.GAS_SERVICE_ACCOUNT_KEY }}' > ~/.clasprc/.clasprc.json
          echo "CLASP credentials configured"

      - name: Verify .clasp.json
        run: |
          echo "Checking .clasp.json..."
          cat .clasp.json
          if [ ! -f .clasp.json ]; then
            echo "Error: .clasp.json not found!"
            exit 1
          fi

      - name: CLASP Login
        run: |
          clasp login --no-localhost
          echo "CLASP login completed"

      - name: Push to Google Apps Script
        run: |
          echo "Pushing code to GAS..."
          clasp push --force
          echo "Push completed"

      - name: Build GAS project
        run: |
          echo "Building GAS project..."
          clasp build || echo "Build step skipped (no clasp.json build config)"

      - name: Deploy Web App
        run: |
          echo "Creating deployment..."
          DEPLOY_ID=$(clasp deploy --description "Auto-deploy from GitHub Actions - $(date +%Y-%m-%d_%H:%M:%S)" | grep -oP 'Deployment ID: \K.*' || echo "")
          if [ -n "$DEPLOY_ID" ]; then
            echo "✓ New deployment created: $DEPLOY_ID"
          else
            echo "Using existing deployment"
          fi

      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "✅ DEPLOYMENT COMPLETED"
          echo "=========================================="
          echo "Script ID: ${{ secrets.GAS_SCRIPT_ID }}"
          echo "Web App URL: https://script.google.com/macros/s/${{ secrets.GAS_SCRIPT_ID }}/exec"
          echo "=========================================="

      - name: Cleanup (remove sensitive credentials)
        if: always()
        run: |
          rm -rf ~/.clasprc
          echo "Cleanup completed"
